<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Escena A-Frame Realista</title>
    <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>
  </head>
  <body>
    <a-scene shadow="type: pcfsoft"
             renderer="antialias: true; colorManagement: true; physicallyCorrectLights: true; toneMapping: ACESFilmic; exposure: 1.0">
      
      <!-- Assets: modelos GLB separados -->
      <a-assets>
        <a-asset-item id="pisoModel" src="models/piso.glb"></a-asset-item>
        <a-asset-item id="paredesModel" src="models/paredes.glb"></a-asset-item>
        <a-asset-item id="techoModel" src="models/techo.glb"></a-asset-item>

        <!-- ASSETS ADICIONALES (cuarto dividido / objetos) -->
        <a-asset-item id="cuarto1" src="models/cuarto1.glb"></a-asset-item>
        <a-asset-item id="cuarto2" src="models/cuarto2.glb"></a-asset-item>
        <a-asset-item id="cuarto3" src="models/cuarto3.glb"></a-asset-item>
        <a-asset-item id="cuarto4" src="models/cuarto4.glb"></a-asset-item>
        <a-asset-item id="cuarto5" src="models/cuarto5.glb"></a-asset-item>
        <a-asset-item id="cuarto6" src="models/cuarto6.glb"></a-asset-item>

        <!-- Otros modelos de assets aquí -->
      </a-assets>

      <!-- NOTA: se quitaron las luces exteriores (ambient + directional) por petición -->

      <!-- LUZ INTERIOR VERDE (se reposiciona al centro del cuarto en loaded) -->
      <a-entity id="greenLamp"
                position="0 2 0"
                light="type: point; color: #2bff7a; intensity: 10; distance: 30; decay: 2; castShadow: true">
      </a-entity>

      <!-- Suelo receptor de sombras (invisible) -->
      <a-entity id="shadowPlane" geometry="primitive: plane; width: 20; height: 20"
                rotation="-90 0 0" position="0 0 0" shadow="receive: true"></a-entity>

      <!-- Modelos GLB cargados -->
      <a-entity id="pisoEntity" gltf-model="#pisoModel" shadow="receive: true"></a-entity>
      <a-entity id="paredesEntity" gltf-model="#paredesModel" shadow="cast: true; receive: true"></a-entity>
      <a-entity id="techoEntity" gltf-model="#techoModel" shadow="cast: true"></a-entity>

      <!-- Entidades extra (cuarto dividido / objetos) -->
      <a-entity id="cuarto1_ent" gltf-model="#cuarto1" shadow="cast: true; receive: true"></a-entity>
      <a-entity id="cuarto2_ent" gltf-model="#cuarto2" shadow="cast: true; receive: true"></a-entity>
      <a-entity id="cuarto3_ent" gltf-model="#cuarto3" shadow="cast: true; receive: true"></a-entity>
      <a-entity id="cuarto4_ent" gltf-model="#cuarto4" shadow="cast: true; receive: true"></a-entity>
      <a-entity id="cuarto5_ent" gltf-model="#cuarto5" shadow="cast: true; receive: true"></a-entity>
      <a-entity id="cuarto6_ent" gltf-model="#cuarto6" shadow="cast: true; receive: true"></a-entity>

      <!-- Cámara y controles -->
      <a-entity id="cameraRig">
        <a-entity camera position="0 1.6 0"
                  look-controls="pointerLockEnabled: true"
                  wasd-controls="acceleration: 100; fly: false">
        </a-entity>
      </a-entity>
    </a-scene>

    <script>
      // Ajustar materia invisibilidad de plano de sombra al cargar la escena
      document.querySelector('a-scene').addEventListener('loaded', () => {
        const scene = document.querySelector('a-scene');

        // Shadow plane -> usar ShadowMaterial para que el plano sea invisible excepto por las sombras
        const plane = document.querySelector('#shadowPlane');
        const mesh = plane.getObject3D('mesh');
        if (mesh) {
          mesh.material = new THREE.ShadowMaterial({ opacity: 0.5 });
          mesh.material.side = THREE.DoubleSide;
        }

        // Centrado automático: calcular bounding box de los modelos (todos los entities con gltf-model)
        const bbox = new THREE.Box3();
        document.querySelectorAll('a-entity[gltf-model]').forEach(ent => {
          const obj = ent.getObject3D('mesh');
          if (obj) bbox.expandByObject(obj);
        });

        // Si no hay modelos cargados, no tocar
        if (bbox.isEmpty()) return;

        const center = bbox.getCenter(new THREE.Vector3());
        const baseY = bbox.min.y;

        // Centrar rig de cámara (como antes)
        const rig = document.querySelector('#cameraRig');
        if (rig && rig.object3D) {
          // colocar rig centrado en X/Z y en altura baseY + 1.6 (altura humana)
          rig.object3D.position.set(center.x, baseY + 1.6, center.z);
        }

        // Posicionar la luz verde dentro del cuarto (centro X/Z, a 2 unidades sobre el piso)
        const green = document.getElementById('greenLamp');
        if (green && green.object3D) {
          const lightY = baseY + 2.0; // 2 metros sobre el piso
          green.object3D.position.set(center.x, lightY, center.z);
          // Asegurarse de que el objeto luz esté instanciado en THREE
          const lightObj = green.getObject3D('light');
          if (lightObj) {
            lightObj.castShadow = true;
            // ajustar mapa de sombras si renderer expone capacidades
            try {
              const renderer = scene.renderer;
              const maxTex = (renderer && renderer.capabilities && renderer.capabilities.maxTextureSize) || 2048;
              const mapSize = Math.min(2048, maxTex);
              if (lightObj.shadow && lightObj.shadow.mapSize) {
                lightObj.shadow.mapSize.width = mapSize;
                lightObj.shadow.mapSize.height = mapSize;
                lightObj.shadow.bias = -0.0005;
                if ('normalBias' in lightObj) lightObj.normalBias = 0.02;
                if (lightObj.shadow.camera && lightObj.shadow.camera.updateProjectionMatrix) {
                  lightObj.shadow.camera.near = 0.1;
                  lightObj.shadow.camera.far = Math.max(50, lightObj.distance || 50);
                  lightObj.shadow.camera.updateProjectionMatrix();
                }
              }
            } catch (e) {
              // no bloquear si algo falla
              console.warn('No se pudo ajustar shadow map de la luz:', e);
            }
          }
        }
      });
    </script>
  </body>
</html>
