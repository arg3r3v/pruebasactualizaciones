<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gerardo Arcos - Cuarto con luz interior</title>

  <!-- A-Frame -->
  <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
  <!-- aframe-extras (movement-controls con nipple/joystick) -->
  <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.5.2/dist/aframe-extras.min.js"></script>
  <!-- physics (cannon + aframe-physics-system) -->
  <script src="https://cdn.jsdelivr.net/gh/schteppe/cannon.js@0.6.2/build/cannon.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-physics-system@4.0.1/dist/aframe-physics-system.min.js"></script>
  <!-- animation-mixer por si tienes animaciones -->
  <script src="https://cdn.jsdelivr.net/npm/aframe-animation-mixer@6.0.0/dist/aframe-animation-mixer.min.js"></script>

  <link rel="stylesheet" href="style.css">
  <link rel="icon" href="img/logo.png" type="image/png">

  <style>
    body { margin: 0; font-family: sans-serif; }
    header { z-index: 10000; position: relative; padding: 12px 18px; background:#fff; display:flex; align-items:center; gap:12px; }
    header h1 { margin:0; font-size:18px; color:#111; }
    nav ul { margin:0; padding:0; list-style:none; display:flex; gap:10px; }
    a-scene[embedded] { width: 100%; height: 72vh; display: block; }
    #poema { padding: 20px; max-width: 900px; margin: 18px auto; }
    #ui-debug { position: fixed; right: 18px; top: 18px; z-index:9999; }
    #toggle-colliders { background:#111; color:#fff; border: none; padding:8px 12px; border-radius:6px; cursor:pointer; }
    /* Importante: NO mostramos colliders por defecto para evitar "líneas" en pantalla */
    .debug-collider { opacity: 0 !important; }
  </style>
</head>
<body>
  <header>
    <h1>GERARDO ARCOS</h1>
    <nav>
      <ul id="nav-list">
        <li><a href="index.html">Inicio</a></li>
        <li><a href="biografia.html">Sobre Mí</a></li>
        <li><a href="proyectos.html">Proyectos</a></li>
        <li><a href="https://arg3r3v.github.io/axolotl/juego.html">Videojuegos</a></li>
      </ul>
    </nav>
  </header>

  <div id="ui-debug">
    <button id="toggle-colliders">Mostrar colliders (D)</button>
  </div>

  <!-- ESCENA -->
  <a-scene embedded
           physics="gravity: 0 -9.8 0"
           shadow="type: pcfsoft"
           renderer="antialias: true; physicallyCorrectLights: true; colorManagement: true">

    <!-- Assets: 6 secciones -->
    <a-assets>
      <a-asset-item id="cuarto1" src="models/cuarto1.glb"></a-asset-item>
      <a-asset-item id="cuarto2" src="models/cuarto2.glb"></a-asset-item>
      <a-asset-item id="cuarto3" src="models/cuarto3.glb"></a-asset-item>
      <a-asset-item id="cuarto4" src="models/cuarto4.glb"></a-asset-item>
      <a-asset-item id="cuarto5" src="models/cuarto5.glb"></a-asset-item>
      <a-asset-item id="cuarto6" src="models/cuarto6.glb"></a-asset-item>
      <!-- personaje opcional -->
      <a-asset-item id="personajeModel" src="models/personaje.glb"></a-asset-item>
    </a-assets>

    <!-- Luz ambiental (suave) -->
    <a-entity light="type: ambient; intensity: 0.06; color: #080808"></a-entity>

    <!-- Tus luces verdes (NO las toco por script; tú decides posiciones/intensidad) -->
    <a-entity id="greenLamp"
              light="type: point; color: #2bff7a; intensity: 18; distance: 12; decay: 2"
              position="-6 4 8"></a-entity>

    <a-entity id="greenSpot"
              light="type: spot; color: #2bff7a; intensity: 9; distance: 12; angle: 0.8; penumbra: 0.6; decay: 2"
              position="-6 4 8" rotation="-90 0 0"></a-entity>

    <!-- RIG para movimiento (joystick on mobile + WASD desktop) -->
    <a-entity id="rig"
              position="0 1.6 4"
              kinematic-body
              movement-controls="controls: gamepad, trackpad, keyboard, nipple">
      <a-entity id="cam"
                camera
                look-controls="touchEnabled: true; magicWindowTrackingEnabled: true; pointerLockEnabled: true">
        <a-entity cursor="rayOrigin: mouse" raycaster="objects: .clickable"></a-entity>
      </a-entity>
    </a-entity>

    <!-- MODELOS: 6 secciones (visual only). Colliders se crean automáticamente desde JS para sec1 -->
    <a-entity id="sec1" gltf-model="#cuarto1" position="0 0 0" shadow="cast: true; receive: true"></a-entity>
    <a-entity id="sec2" gltf-model="#cuarto2" position="0 0 0" shadow="cast: true; receive: true"></a-entity>
    <a-entity id="sec3" gltf-model="#cuarto3" position="0 0 0" shadow="cast: true; receive: true"></a-entity>
    <a-entity id="sec4" gltf-model="#cuarto4" position="0 0 0" shadow="cast: true; receive: true"></a-entity>
    <a-entity id="sec5" gltf-model="#cuarto5" position="0 0 0" shadow="cast: true; receive: true"></a-entity>
    <a-entity id="sec6" gltf-model="#cuarto6" position="0 0 0" shadow="cast: true; receive: true"></a-entity>

    <!-- Personaje decorativo (opcional) -->
    <a-entity id="personaje" gltf-model="#personajeModel" position="1 0 -2" scale="1 1 1" animation-mixer="clip: *; loop: repeat" shadow="cast: true"></a-entity>

  </a-scene>

  <!-- Contenido HTML fuera de la escena -->
  <div id="poema">
    <h2>PORQUE AÚN SOY JOVEN</h2>
    <p class="poem">
      Porque aún soy joven, y algo necio,<br>
      Aún soy joven para errar sin malicia,<br>
      Para amar con verdad y sin prisa,<br>
      Para aprender lo que el tiempo avisa,<br>
      Y perderme en charlas de risa,<br>
      En conversaciones sin juicio.
    </p>
  </div>

<!-- ==== SCRIPT: sin tocar luces; quita líneas; colisiones en 'cuarto1'; centra cámara en 'cuarto1' ==== -->
<script>
(function(){
  const COLLIDER_CLASS = 'auto-collider';
  const DEBUG_COLLIDER_CLASS = 'debug-collider'; // sólo para alternar visibilidad
  const WALL_THICKNESS = 0.1; // paredes delgadas para colisión

  function waitForSceneReady(cb) {
    const scene = document.querySelector('a-scene');
    if (!scene) { console.warn('No a-scene en DOM'); return; }
    if (scene.hasLoaded) return cb(scene);
    scene.addEventListener('loaded', () => cb(scene), { once: true });
  }

  waitForSceneReady(sceneEl => {
    const rig = document.getElementById('rig');
    const toggleBtn = document.getElementById('toggle-colliders');
    const sec1 = document.getElementById('sec1'); // SOLO usamos cuarto1 como base de colisión

    // --- Helpers ---
    const THREE = window.THREE;

    function computeBBoxOfEntity(entity) {
      const obj = entity.getObject3D('mesh') || entity.object3D;
      if (!obj) return null;
      const box = new THREE.Box3().setFromObject(obj);
      if (box.isEmpty()) return null;
      const size = new THREE.Vector3(); box.getSize(size);
      const center = new THREE.Vector3(); box.getCenter(center);
      const min = box.min.clone();
      const max = box.max.clone();
      return { box, size, center, min, max };
    }

    function createRoomCollidersFromBBox(sceneEl, bbox) {
      // Limpia colliders anteriores
      sceneEl.querySelectorAll('.' + COLLIDER_CLASS).forEach(e => e.remove());

      const { size, center, min, max } = bbox;

      // Piso
      addBox(sceneEl, {
        pos: [center.x, min.y + WALL_THICKNESS/2, center.z],
        dim: [size.x, WALL_THICKNESS, size.z]
      });

      // Techo
      addBox(sceneEl, {
        pos: [center.x, max.y - WALL_THICKNESS/2, center.z],
        dim: [size.x, WALL_THICKNESS, size.z]
      });

      // Pared +X
      addBox(sceneEl, {
        pos: [max.x - WALL_THICKNESS/2, center.y, center.z],
        dim: [WALL_THICKNESS, size.y, size.z]
      });

      // Pared -X
      addBox(sceneEl, {
        pos: [min.x + WALL_THICKNESS/2, center.y, center.z],
        dim: [WALL_THICKNESS, size.y, size.z]
      });

      // Pared +Z
      addBox(sceneEl, {
        pos: [center.x, center.y, max.z - WALL_THICKNESS/2],
        dim: [size.x, size.y, WALL_THICKNESS]
      });

      // Pared -Z
      addBox(sceneEl, {
        pos: [center.x, center.y, min.z + WALL_THICKNESS/2],
        dim: [size.x, size.y, WALL_THICKNESS]
      });

      function addBox(sceneEl, {pos, dim}) {
        const e = document.createElement('a-box');
        e.classList.add(COLLIDER_CLASS);
        e.classList.add(DEBUG_COLLIDER_CLASS);
        e.setAttribute('position', pos.join(' '));
        e.setAttribute('width', dim[0]);
        e.setAttribute('height', dim[1]);
        e.setAttribute('depth', dim[2]);
        e.setAttribute('static-body', 'shape: box;');
        e.setAttribute('visible', 'false'); // IMPORTANTE: invisible por defecto (sin líneas raras)
        sceneEl.appendChild(e);
      }
    }

    function toggleCollidersVisibility(show) {
      sceneEl.querySelectorAll('.' + COLLIDER_CLASS).forEach(e => {
        e.setAttribute('visible', show ? 'true' : 'false');
      });
    }

    function setupToggleUI() {
      if (!toggleBtn) return;
      let shown = false;
      const update = () => {
        toggleCollidersVisibility(shown);
        toggleBtn.textContent = shown ? 'Ocultar colliders (D)' : 'Mostrar colliders (D)';
      };
      toggleBtn.addEventListener('click', () => { shown = !shown; update(); });
      window.addEventListener('keydown', (ev)=> { if (ev.key.toLowerCase()==='d') { shown = !shown; update(); } });
      update();
    }

    function centerRigInSec1(bbox) {
      if (!rig) return;
      const c = bbox.center;
      // Colocamos el RIG exactamente al centro del cuarto (X,Y,Z)
      rig.setAttribute('position', `${c.x} ${c.y} ${c.z}`);
      console.log('Rig centrado en cuarto1:', c);
    }

    // --- FLUJO ---
    // No tocamos luces en absoluto (ni posición ni intensidad).

    // Esperamos a que sec1 cargue para calcular bbox y montar colisiones/cámara
    if (sec1 && (sec1.getObject3D('mesh') || sec1.getObject3D('gltf'))) {
      const bbox = computeBBoxOfEntity(sec1);
      if (bbox) {
        createRoomCollidersFromBBox(sceneEl, bbox);
        centerRigInSec1(bbox);
      } else {
        console.warn('No se pudo calcular bbox de sec1.');
      }
      setupToggleUI();
    } else if (sec1) {
      sec1.addEventListener('model-loaded', () => {
        const bbox = computeBBoxOfEntity(sec1);
        if (bbox) {
          createRoomCollidersFromBBox(sceneEl, bbox);
          centerRigInSec1(bbox);
        } else {
          console.warn('No se pudo calcular bbox de sec1 (tras model-loaded).');
        }
        setupToggleUI();
      }, { once: true });
    } else {
      console.warn('No existe #sec1 en la escena.');
      setupToggleUI();
    }
  });
})();
</script>

  <script defer src="script.js"></script>
</body>
</html>
