<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>A-Frame escena (v1.6.0) - Cuarto con GLB (ajustes)</title>
  <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
  <style>
    html, body { margin: 0; height: 100%; background: #000; }
    a-scene { width: 100%; height: 100vh; display: block; }
    #note {
      position: absolute;
      left: 8px;
      bottom: 8px;
      z-index: 9999;
      font-family: sans-serif;
      font-size: 12px;
      color: #ddd;
      background: rgba(0,0,0,0.35);
      padding: 6px 8px;
      border-radius: 6px;
      pointer-events: none;
    }
  </style>
</head>
<body>
  <div id="note">Cámara centrada (medio del cuarto 3m x 3m) — sombras triplicadas</div>

  <a-scene background="color: #000" vr-mode-ui="enabled: true" embedded
           renderer="colorManagement: true"
           loading-screen="enabled: true">

    <!-- Assets (rutas EXACTAS según lo solicitado) -->
    <a-assets timeout="0">
      <a-asset-item id="techo"   src="models/techo.glb"></a-asset-item>
      <a-asset-item id="piso"    src="models/piso.glb"></a-asset-item>
      <a-asset-item id="paredes" src="models/paredes.glb"></a-asset-item>

      <a-asset-item id="assets1" src="models/asset1s.glb"></a-asset-item>
      <a-asset-item id="assets2" src="models/assets2.glb"></a-asset-item>
      <a-asset-item id="assets3" src="models/assets3.glb"></a-asset-item>
      <a-asset-item id="assets4" src="models/assets4.glb"></a-asset-item>
      <a-asset-item id="assets5" src="models/assets5.glb"></a-asset-item>
      <a-asset-item id="assets6" src="models/assets6.glb"></a-asset-item>
      <a-asset-item id="assets7" src="models/assets7.glb"></a-asset-item>
    </a-assets>

    <!-- Luz puntual verde en el centro — NO mover la luz en el código -->
    <a-entity id="greenLamp"
              position="0 1 0"
              light="type: point; color: #2bff7a; intensity: 1.6; distance: 12; decay: 2; castShadow: true"
              shadow="cast: true; receive: false">
    </a-entity>

    <!-- Rig centrado en el medio del cuarto.
         Las paredes miden 3 m; por tanto colocamos la cámara en el centro: (1.5, 0, 1.5).
         Cámara a altura humana y=1.6 -->
    <a-entity id="rig" position="1.5 0 1.5" wasd-controls="acceleration: 30">
      <a-entity id="head" position="0 1.6 0">
        <a-camera id="camera"
                  look-controls="pointerLockEnabled: false; touchEnabled: true"
                  fov="75"
                  near="0.01"
                  far="1000">
          <a-cursor id="cursor" fuse="false" rayOrigin="mouse" visible="false"></a-cursor>
        </a-camera>
      </a-entity>
    </a-entity>

    <!-- Cada GLB cargado en su propia entidad (sin alterar transformaciones internas) -->
    <a-entity id="techo-entity"    gltf-model="#techo"    shadow="cast: true; receive: true"></a-entity>
    <a-entity id="piso-entity"     gltf-model="#piso"     shadow="cast: true; receive: true"></a-entity>
    <a-entity id="paredes-entity"  gltf-model="#paredes"  shadow="cast: true; receive: true"></a-entity>

    <a-entity id="asset1-entity" gltf-model="#assets1" shadow="cast: true; receive: true"></a-entity>
    <a-entity id="asset2-entity" gltf-model="#assets2" shadow="cast: true; receive: true"></a-entity>
    <a-entity id="asset3-entity" gltf-model="#assets3" shadow="cast: true; receive: true"></a-entity>
    <a-entity id="asset4-entity" gltf-model="#assets4" shadow="cast: true; receive: true"></a-entity>
    <a-entity id="asset5-entity" gltf-model="#assets5" shadow="cast: true; receive: true"></a-entity>
    <a-entity id="asset6-entity" gltf-model="#assets6" shadow="cast: true; receive: true"></a-entity>
    <a-entity id="asset7-entity" gltf-model="#assets7" shadow="cast: true; receive: true"></a-entity>

    <!-- Plano receptor de sombras en el piso — visible para verificar sombras -->
    <a-plane id="shadow-receiver" position="1.5 0 1.5" rotation="-90 0 0" width="3" height="3" visible="true" recieve-shadow></a-plane>

    <!-- Script: configurar renderer (shadow maps triplicados) y reducir ruido en sombras -->
    <script>
      (function () {
        const scene = document.querySelector('a-scene');

        function isMobile() {
          try {
            return window.matchMedia && window.matchMedia('(pointer: coarse)').matches
                   || 'ontouchstart' in window
                   || navigator.maxTouchPoints > 0;
          } catch (e) { return false; }
        }

        scene.addEventListener('render-target-loaded', function () {
          const renderer = scene.renderer;
          if (!renderer) { return; }

          // Activar shadow map y tipo suave
          renderer.shadowMap.enabled = true;
          renderer.shadowMap.type = THREE.PCFSoftShadowMap;

          // Encoding sRGB para materiales
          renderer.outputEncoding = THREE.sRGBEncoding;

          // Ajuste de pixel ratio (limitar para balance rendimiento/ruido)
          renderer.setPixelRatio(Math.min(window.devicePixelRatio || 1, 2));

          // Opciones para mejorar calidad/ruido
          try {
            renderer.physicallyCorrectLights = true;
            // Tone mapping ayuda a evitar clipping y puede mejorar sensación de ruido en altas luces
            renderer.toneMapping = THREE.ACESFilmicToneMapping;
            renderer.toneMappingExposure = 1.0;
          } catch (e) { /* no crítico si no existe */ }

          // Obtener la luz puntual
          const greenLampEl = document.getElementById('greenLamp');
          let lightObj = null;
          if (greenLampEl) {
            lightObj = greenLampEl.getObject3D && greenLampEl.getObject3D('light');
          }

          const mobile = isMobile();

          // Valores base anteriores: desktop 2048, mobile 1024.
          // El usuario pidió TRIPLICAR los shadow maps → multiplicar por 3.
          const baseDesktop = 2048;
          const baseMobile  = 1024;
          const chosenSize = mobile ? baseMobile * 3 : baseDesktop * 3; // 3072 móvil, 6144 desktop

          if (lightObj && lightObj.shadow) {
            try {
              lightObj.castShadow = true;
              // Ajustar mapSize para mejores sombras (triplicado)
              if (lightObj.shadow.mapSize && typeof lightObj.shadow.mapSize.set === 'function') {
                lightObj.shadow.mapSize.set(chosenSize, chosenSize);
                lightObj.shadow.needsUpdate = true;
              }
              // Ajustar radius para suavizar artefactos (reduce banding/ruido en sombras)
              if (typeof lightObj.shadow.radius !== 'undefined') {
                lightObj.shadow.radius = 4;
              }
              // Aumentar bias ligeramente para prevenir acne de sombras en escenas con muchos polígonos
              if (typeof lightObj.shadow.bias !== 'undefined') {
                lightObj.shadow.bias = -0.0005;
              }
            } catch (err) {
              console.warn('No se pudo ajustar completamente lightObj.shadow:', err);
            }
          }

          // Habilitar cast/receive shadows en mallas glTF al cargarse y mejorar encoding de texturas
          const gltfEntities = [
            'techo-entity','piso-entity','paredes-entity',
            'asset1-entity','asset2-entity','asset3-entity','asset4-entity','asset5-entity','asset6-entity','asset7-entity'
          ].map(id => document.getElementById(id)).filter(Boolean);

          gltfEntities.forEach(function (el) {
            el.addEventListener('model-loaded', function (evt) {
              const model = (evt.detail && evt.detail.model) ? evt.detail.model : el.getObject3D('gltf') || el.getObject3D('mesh');
              const obj = model || el.getObject3D('mesh') || el.getObject3D('gltf');
              if (obj) {
                obj.traverse(function (node) {
                  if (node.isMesh) {
                    node.castShadow = true;
                    node.receiveShadow = true;
                    if (node.material) {
                      // Forzar encoding de texturas a sRGB si aplicable para reducir incorrecta luminancia que puede generar ruido
                      if (node.material.map) {
                        node.material.map.encoding = THREE.sRGBEncoding;
                      }
                      node.material.needsUpdate = true;
                    }
                  }
                });
              }
            }, { once: false });
          });

          // Consola informativa
          console.log('Renderer configurado: shadowMap.enabled=', renderer.shadowMap.enabled,
                      ' type=', renderer.shadowMap.type,
                      ' pixelRatio=', renderer.getPixelRatio ? renderer.getPixelRatio() : (window.devicePixelRatio || 1),
                      ' shadowMapSize=', chosenSize,
                      ' mobile=', mobile);
        });

        // No más cambios a transformaciones internas de los GLB.
      })();
    </script>

  </a-scene>
</body>
</html>
