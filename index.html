<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>A-Frame escena (v1.6.0) - Cuarto con GLB</title>
  <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
  <style>
    html, body { margin: 0; height: 100%; background: #000; }
    a-scene { width: 100%; height: 100vh; display: block; }
    /* UI minimal para informar si se requiere */
    #note {
      position: absolute;
      left: 8px;
      bottom: 8px;
      z-index: 9999;
      font-family: sans-serif;
      font-size: 12px;
      color: #ddd;
      background: rgba(0,0,0,0.35);
      padding: 6px 8px;
      border-radius: 6px;
      pointer-events: none;
    }
  </style>
</head>
<body>
  <div id="note">A-Frame v1.6.0 — cámara rig y soporte móvil/táctil habilitado</div>

  <!-- Escena A-Frame -->
  <a-scene background="color: #000" vr-mode-ui="enabled: true" embedded
           renderer="colorManagement: true"
           loading-screen="enabled: true">

    <!-- Assets (usar rutas EXACTAS según lo solicitado) -->
    <a-assets timeout="0">
      <a-asset-item id="techo"   src="models/techo.glb"></a-asset-item>
      <a-asset-item id="piso"    src="models/piso.glb"></a-asset-item>
      <a-asset-item id="paredes" src="models/paredes.glb"></a-asset-item>

      <!-- Nota: siguiendo exactamente la instrucción dada -->
      <a-asset-item id="assets1" src="models/asset1s.glb"></a-asset-item>
      <a-asset-item id="assets2" src="models/assets2.glb"></a-asset-item>
      <a-asset-item id="assets3" src="models/assets3.glb"></a-asset-item>
      <a-asset-item id="assets4" src="models/assets4.glb"></a-asset-item>
      <a-asset-item id="assets5" src="models/assets5.glb"></a-asset-item>
      <a-asset-item id="assets6" src="models/assets6.glb"></a-asset-item>
      <a-asset-item id="assets7" src="models/assets7.glb"></a-asset-item>
    </a-assets>

    <!-- Luz puntual verde en el centro — NO mover la luz en el código -->
    <a-entity id="greenLamp"
              position="0 1 0"
              light="type: point; color: #2bff7a; intensity: 1.6; distance: 12; decay: 2; castShadow: true"
              shadow="cast: true; receive: false">
    </a-entity>

    <!-- Rig (móvil y escritorio). Cámara a y=1.6 -->
    <a-entity id="rig" position="0 0 0" wasd-controls="acceleration: 30">
      <a-entity id="head"
                position="0 1.6 0">
        <a-camera id="camera"
                  look-controls="pointerLockEnabled: false; touchEnabled: true"
                  fov="75"
                  near="0.01"
                  far="1000"
                  wasd-controls-enabled="false">
          <!-- Cursor solo para interacción en VR/desktop cuando se active -->
          <a-cursor id="cursor" fuse="false" rayOrigin="mouse" visible="false"></a-cursor>
        </a-camera>
      </a-entity>
    </a-entity>

    <!-- Cada GLB cargado en su propia entidad (sin alterar transformaciones internas) -->
    <!-- No cambiamos posiciones/rotaciones internas: colocamos cada gltf-model en su propia entidad tal cual -->
    <a-entity id="techo-entity" gltf-model="#techo" shadow="cast: true; receive: true"></a-entity>
    <a-entity id="piso-entity"  gltf-model="#piso"  shadow="cast: true; receive: true"></a-entity>
    <a-entity id="paredes-entity" gltf-model="#paredes" shadow="cast: true; receive: true"></a-entity>

    <a-entity id="asset1-entity" gltf-model="#assets1" shadow="cast: true; receive: true"></a-entity>
    <a-entity id="asset2-entity" gltf-model="#assets2" shadow="cast: true; receive: true"></a-entity>
    <a-entity id="asset3-entity" gltf-model="#assets3" shadow="cast: true; receive: true"></a-entity>
    <a-entity id="asset4-entity" gltf-model="#assets4" shadow="cast: true; receive: true"></a-entity>
    <a-entity id="asset5-entity" gltf-model="#assets5" shadow="cast: true; receive: true"></a-entity>
    <a-entity id="asset6-entity" gltf-model="#assets6" shadow="cast: true; receive: true"></a-entity>
    <a-entity id="asset7-entity" gltf-model="#assets7" shadow="cast: true; receive: true"></a-entity>

    <!-- Opcional: plano receptor de sombras si se desea, pero sin interferir con GLB -->
    <a-plane id="shadow-receiver" position="0 0 0" rotation="-90 0 0" width="20" height="20" visible="false"></a-plane>

    <!-- Script para configurar renderer y sombras según dispositivo, y para habilitar cast/receive en mallas GLTF -->
    <script>
      (function () {
        const scene = document.querySelector('a-scene');

        // Utilidad para detectar móvil: pointer:coarse OR touch capability
        function isMobile() {
          try {
            return window.matchMedia && window.matchMedia('(pointer: coarse)').matches
                   || 'ontouchstart' in window
                   || navigator.maxTouchPoints > 0;
          } catch (e) { return false; }
        }

        scene.addEventListener('render-target-loaded', function () {
          // A-Frame ha creado el renderer → configúralo según lo pedido
          const renderer = scene.renderer;
          if (!renderer) { return; }

          // Activar shadow map y tipo
          renderer.shadowMap.enabled = true;
          // THREE está disponible globalmente en A-Frame
          renderer.shadowMap.type = THREE.PCFSoftShadowMap;
          // Output encoding sRGB
          renderer.outputEncoding = THREE.sRGBEncoding;

          // Pixel ratio: limitar para no saturar móviles
          renderer.setPixelRatio(Math.min(window.devicePixelRatio || 1, 2));

          // Ajustes de tamaño de shadow map en la luz puntual (greenLamp)
          const greenLampEl = document.getElementById('greenLamp');
          const lightObj = greenLampEl && greenLampEl.getObject3D && greenLampEl.getObject3D('light');

          // Decide tamaño en base a dispositivo
          const mobile = isMobile();
          // Tamaños sugeridos: desktop entre 1024 y 2048; móvil menor (ej. 1024)
          const shadowSizeDesktop = 2048; // dentro del rango pedido
          const shadowSizeMobile  = 1024; // menor para móviles

          const chosenSize = mobile ? shadowSizeMobile : shadowSizeDesktop;

          if (lightObj && lightObj.shadow) {
            // Para point lights, shadow is a LightShadow with a mapSize
            try {
              lightObj.castShadow = true;
              if (lightObj.shadow && lightObj.shadow.mapSize && typeof lightObj.shadow.mapSize.set === 'function') {
                lightObj.shadow.mapSize.set(chosenSize, chosenSize);
                lightObj.shadow.needsUpdate = true;
              }
            } catch (err) {
              console.warn('No se pudo ajustar mapSize de la luz (lightObj.shadow).', err);
            }
          }

          // Para mejorar desempeño en móviles, desactivar antialias si es móvil (opcional, no cambia transformaciones internas)
          if (mobile) {
            try {
              renderer.antialias = false;
            } catch (e) { /* no crítico */ }
          }

          // Activar sombras en cada glTF cuando cargue (cada entidad tiene gltf-model)
          const gltfEntities = [
            'techo-entity','piso-entity','paredes-entity',
            'asset1-entity','asset2-entity','asset3-entity','asset4-entity','asset5-entity','asset6-entity','asset7-entity'
          ].map(id => document.getElementById(id)).filter(Boolean);

          gltfEntities.forEach(function (el) {
            el.addEventListener('model-loaded', function (evt) {
              const model = evt.detail && evt.detail.model ? evt.detail.model : el.getObject3D('mesh') || el.getObject3D('gltf');
              // The glTF loader attaches the scene in evt.detail.model (a THREE.Object3D)
              const obj = evt.detail && evt.detail.model ? evt.detail.model : el.getObject3D('mesh') || el.getObject3D('gltf');

              if (obj) {
                obj.traverse(function (node) {
                  // Habilitar cast/receive shadows en mallas (no tocar transformaciones)
                  if (node.isMesh) {
                    node.castShadow = true;
                    node.receiveShadow = true;
                    // En caso de usar materials que requieran sRGB correction, marcar si aplica:
                    if (node.material && node.material.map) {
                      node.material.map.encoding = THREE.sRGBEncoding;
                      node.material.needsUpdate = true;
                    }
                  }
                });
              }
            }, { once: false });
          });

          // Información de consola para debugging (opcional)
          console.log('Renderer configurado: shadowMap.enabled=', renderer.shadowMap.enabled,
                      ' type=', renderer.shadowMap.type,
                      ' pixelRatio=', renderer.getPixelRatio ? renderer.getPixelRatio() : (window.devicePixelRatio || 1),
                      ' shadowSize=', chosenSize);
        });

        // Asegurar que look-controls está activo en la cámara y wasd controla el rig
        // (ya configurado en el HTML; aquí mantenemos por compatibilidad)
        // Nothing further required.
      })();
    </script>

  </a-scene>
</body>
</html>
