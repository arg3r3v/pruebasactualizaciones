<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Galería — techo/piso/paredes</title>
  <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
  <style>
    html,body{margin:0;height:100%;background:#000}
    a-scene{width:100%;height:100vh;display:block}
  </style>
</head>
<body>
<a-scene id="scene" background="color:#000" embedded renderer="colorManagement:true">
  <!-- ASSETS -->
  <a-assets timeout="0">
    <a-asset-item id="techo" src="models/techo.glb"></a-asset-item>
    <a-asset-item id="piso" src="models/piso.glb"></a-asset-item>
    <a-asset-item id="paredes" src="models/paredes.glb"></a-asset-item>

    <a-asset-item id="assets1" src="models/assets1.glb"></a-asset-item>
    <a-asset-item id="assets2" src="models/assets2.glb"></a-asset-item>
    <a-asset-item id="assets3" src="models/assets3.glb"></a-asset-item>
    <a-asset-item id="assets4" src="models/assets4.glb"></a-asset-item>
    <a-asset-item id="assets5" src="models/assets5.glb"></a-asset-item>
    <a-asset-item id="assets6" src="models/assets6.glb"></a-asset-item>
  </a-assets>

  <!-- LUZ -->
  <a-entity id="greenLamp"
            position="0 1 0"
            light="type: point; color: #2bff7a; intensity: 1.6; distance: 12; decay: 2; castShadow: true">
  </a-entity>

  <!-- RIG + CÁMARA -->
  <a-entity id="rig" position="1.5 1.6 1.5" smooth-walk>
    <a-camera id="camera" position="0 0 0" look-controls="pointerLockEnabled:false; touchEnabled:true"></a-camera>
  </a-entity>

  <!-- ESCENA -->
  <a-entity id="techo-entity"   gltf-model="#techo"   shadow="cast:true; receive:true"></a-entity>
  <a-entity id="piso-entity"    gltf-model="#piso"    shadow="cast:true; receive:true"></a-entity>
  <a-entity id="paredes-entity" gltf-model="#paredes" shadow="cast:true; receive:true"></a-entity>

  <a-entity id="asset1-entity" gltf-model="#assets1" shadow="cast:true; receive:true"></a-entity>
  <a-entity id="asset2-entity" gltf-model="#assets2" shadow="cast:true; receive:true"></a-entity>
  <a-entity id="asset3-entity" gltf-model="#assets3" shadow="cast:true; receive:true"></a-entity>
  <a-entity id="asset4-entity" gltf-model="#assets4" shadow="cast:true; receive:true"></a-entity>
  <a-entity id="asset5-entity" gltf-model="#assets5" shadow="cast:true; receive:true"></a-entity>
  <a-entity id="asset6-entity" gltf-model="#assets6" shadow="cast:true; receive:true"></a-entity>

  <!-- PLANO INVISIBLE PARA SOMBRAS -->
  <a-plane id="shadow-receiver"
           rotation="-90 0 0"
           position="1.5 0 1.5"
           width="3" height="3"
           material="color:#000; opacity:0; transparent:true"
           shadow="receive:true"></a-plane>
</a-scene>

<script>
/* ---------- COMPONENTE smooth-walk ---------- */
AFRAME.registerComponent('smooth-walk',{
  schema:{ speed:{default:0.06}, smoothing:{default:12}, maxStep:{default:0.03} },
  init:function(){
    this.vel=new THREE.Vector3();
    this.target=new THREE.Vector3();
    this.keys={f:0,b:0,l:0,r:0};
    this.touchMove=false;
    this.bounds=null;
    this._kd=e=>{ if(e.code==='KeyW'||e.code==='ArrowUp')this.keys.f=1;
                  if(e.code==='KeyS'||e.code==='ArrowDown')this.keys.b=1;
                  if(e.code==='KeyA'||e.code==='ArrowLeft')this.keys.l=1;
                  if(e.code==='KeyD'||e.code==='ArrowRight')this.keys.r=1; };
    this._ku=e=>{ if(e.code==='KeyW'||e.code==='ArrowUp')this.keys.f=0;
                  if(e.code==='KeyS'||e.code==='ArrowDown')this.keys.b=0;
                  if(e.code==='KeyA'||e.code==='ArrowLeft')this.keys.l=0;
                  if(e.code==='KeyD'||e.code==='ArrowRight')this.keys.r=0; };
    window.addEventListener('keydown',this._kd);
    window.addEventListener('keyup',this._ku);
    this._ts=e=>{this.touchMove=(e.touches&&e.touches.length>1);};
    this._tm=e=>{this.touchMove=(e.touches&&e.touches.length>1);};
    this._te=e=>{this.touchMove=(e.touches&&e.touches.length>1);};
    window.addEventListener('touchstart',this._ts,{passive:true});
    window.addEventListener('touchmove',this._tm,{passive:true});
    window.addEventListener('touchend',this._te,{passive:true});
  },
  tick:function(t,dt){
    const delta=Math.min(dt/1000,0.05);
    const camEl=this.el.querySelector('[camera]');
    let yaw=0;
    if(camEl&&camEl.object3D){
      const q=camEl.object3D.quaternion;
      const e=new THREE.Euler().setFromQuaternion(q,'YXZ');
      yaw=e.y;
    }
    const yawQ=new THREE.Quaternion().setFromEuler(new THREE.Euler(0,yaw,0));
    const forward=new THREE.Vector3(0,0,-1).applyQuaternion(yawQ).setY(0).normalize();
    const right=new THREE.Vector3().crossVectors(forward,new THREE.Vector3(0,1,0)).normalize();
    const moveZ=(this.keys.f-this.keys.b)+(this.touchMove?1:0);
    const moveX=(this.keys.r-this.keys.l);
    this.target.set(0,0,0);
    if(Math.abs(moveZ)>0||Math.abs(moveX)>0){
      this.target.add(forward.clone().multiplyScalar(moveZ));
      this.target.add(right.clone().multiplyScalar(moveX));
      this.target.normalize().multiplyScalar(this.data.speed);
    }
    const alpha=1-Math.exp(-this.data.smoothing*delta);
    this.vel.lerp(this.target,alpha);
    const step=this.vel.clone().multiplyScalar(delta);
    if(step.length()>this.data.maxStep)step.multiplyScalar(this.data.maxStep/step.length());
    this.el.object3D.position.add(step);
    if(this.bounds){
      const p=this.el.object3D.position;
      p.x=Math.min(Math.max(p.x,this.bounds.minX),this.bounds.maxX);
      p.z=Math.min(Math.max(p.z,this.bounds.minZ),this.bounds.maxZ);
      p.y=Math.min(Math.max(p.y,this.bounds.minY),this.bounds.maxY);
      this.el.object3D.position.copy(p);
    }
  },
  setBounds:function(b){this.bounds=b;}
});

/* ---------- CONFIG Y CENTRADO ---------- */
(function(){
  const sceneEl=document.getElementById('scene');
  const rigEl=document.getElementById('rig');
  const camEl=document.getElementById('camera');
  const shadowPlane=document.getElementById('shadow-receiver');
  const essentials=['techo-entity','piso-entity','paredes-entity'];
  const loaded={};
  essentials.forEach(id=>loaded[id]=null);

  function sanitize(obj){
    obj.traverse(n=>{
      if(n.isMesh){
        n.castShadow=true;
        n.receiveShadow=true;
        if(n.material){
          n.material.transparent=true;
          if(n.material.map) n.material.map.encoding=THREE.sRGBEncoding;
          n.material.needsUpdate=true;
        }
      }
    });
  }

  essentials.forEach(id=>{
    const el=document.getElementById(id);
    el.addEventListener('model-loaded',evt=>{
      const obj=evt.detail.model.scene||evt.detail.model;
      loaded[id]=obj;
      sanitize(obj);
      tryCenter();
    });
  });

  function tryCenter(){
    const objs=Object.values(loaded).filter(Boolean);
    if(!objs.length) return;
    const box=new THREE.Box3();
    objs.forEach(o=>box.expandByObject(o));
    if(box.isEmpty()) return;
    const center=new THREE.Vector3();
    box.getCenter(center);
    const size=new THREE.Vector3();
    box.getSize(size);
    const baseY=box.min.y;
    const rigY=baseY+1.6;
    rigEl.object3D.position.set(center.x,rigY,center.z);
    camEl.setAttribute('position','0 0 0');
    shadowPlane.setAttribute('position',`${center.x} ${baseY+0.001} ${center.z}`);
    shadowPlane.setAttribute('width',size.x);
    shadowPlane.setAttribute('height',size.z);
    const bounds={minX:box.min.x,maxX:box.max.x,minZ:box.min.z,maxZ:box.max.z,minY:rigY,maxY:rigY};
    const comp=rigEl.components['smooth-walk'];
    if(comp) comp.setBounds(bounds);
  }
})();
</script>
</body>
</html>
